<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"
    />

    <title>Labb 4</title>

    <style>
      /* @import "ui/css/evothings-app.css"; */
    </style>

    <script>
      // Redirect console.log to Evothings Workbench.
      // if (window.hyper && window.hyper.log) {
      //   dconsole.log = hyper.log;
      // }
    </script>

    <!-- <script src="libs/jquery/jquery.js"></script> -->
    <script src="https://code.jquery.com/jquery-3.4.0.min.js"></script>
    <!-- Instantiate PubNub -->
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.7.js"></script>

    <script type="text/javascript">
      // $("#firstpage").show();
      //$("#chatroom").hide();

      let username = "UNKNOWN";

      enterChatroom = e => {
        e.preventDefault();
        username = document.getElementById("username").value;
        document.getElementById("name").innerText = username;
        document.getElementById("chatroom").style.display = "block";
        document.getElementById("firstpage").style.display = "none";

        // $("#firstpage").hide();
        // $("#chatroom").show();
      };

      var pubnub = new PubNub({
        publishKey: "pub-c-c42f11f2-1108-438a-ae06-bfe3787a8131",

        subscribeKey: "sub-c-ca7b08c8-67f5-11e9-81d5-56c3556875f9"
      });

      // Subscribe to the demo_tutorial channel pubnub
      pubnub.addListener({
        message: function(message) {
          let newMessage = document.createElement("p");
          newMessage.innerHTML =
            "From: " +
            message.message.from +
            "<br />" +
            message.message.message;

          document.getElementById("messages").appendChild(newMessage);
          // document.getElementById("message").innerHTML = message_array;
          // document.getElementById("publisher").innerHTML = message.message.from;
        }
      });

      subscribeToChannel = direction => {
        // Unsubbar till alla kanaler
        var channels = ["North", "East", "West", "South"];
        let result = channels.filter(index => index != direction);

        pubnub.unsubscribe({
          channels: result
        });

        document.getElementById("active_room").innerHTML = direction;

        //Subbar till specifik kanal
        pubnub.subscribe({
          channels: [direction]
        });
      };

      sendMessage = e => {
        // Publish a simple message to the “demo_tutorial” channel pubnub:
        e.preventDefault();
        // let from = document.getElementById("from").value;
        let direction = document.getElementById("active_room").innerText;
        let message = document.getElementById("new-message").value;

        pubnub.publish({
          message: { from: username, message: message },
          channel: [direction]
        });
      };
    </script>

    <!-- Script för navigering av mobil, koodianater -->
    <script>
      // // Get event data
      function deviceOrientationListener(event) {
        let element = document.getElementById("orientation");
        var alpha = event.alpha; //z axis rotation [0,360)
        var beta = event.beta; //x axis rotation [-180, 180]
        var gamma = event.gamma; //y axis rotation [-90, 90]

        /* element.innerHTML =
          "Alpha: " +
          event.alpha.toFixed([0]) +
          "<br/> Beta: " +
          event.beta.toFixed([0]) +
          "<br/> Gamma: " +
          event.gamma.toFixed([0]); */

        /* if (typeof event.webkitCompassHeading !== "undefined") {
          alpha = event.webkitCompassHeading; //for iOS devices
        } else {
          alpha = 360 - alpha; //heading [0, 360)
        } */

        if (alpha.toFixed([0]) > 315 || alpha.toFixed([0]) < 45) {
          subscribeToChannel("North");
        } else if (alpha.toFixed([0]) > 45 && alpha.toFixed([0]) < 135) {
          subscribeToChannel("West");
        } else if (alpha.toFixed([0]) > 135 && alpha.toFixed([0]) < 225) {
          subscribeToChannel("South");
        } else if (alpha.toFixed([0]) > 225 && alpha.toFixed([0]) < 314) {
          subscribeToChannel("East");
        }
      }

      if (window.DeviceOrientationEvent) {
        // alert("Works!");
        window.addEventListener(
          "deviceorientation",
          deviceOrientationListener,
          true
        );
      } else {
        alert("Doesn't work!");
      }
    </script>
    <!-- Slut på koden med navigeringen, (del 2 i labben) -->
  </head>

  <body ontouchstart="">
    <div id="firstpage">
      <h1>Welcome to Chat Along</h1>
      <h2>
        You join channels by pointing your mobilephone towards specific
        directions. <i>North, </i><i>East, </i><i>South, </i><i>West</i>
      </h2>
      <h4>Please enter username to start chatting</h4>
      <form onsubmit="enterChatroom(event)">
        <input
          type="text"
          placeholder="Enter username!"
          id="username"
          name="username"
        />
        <button type="submit">Select</button>
      </form>

      <pre>version 21</pre>
      <p id="orientation"></p>
    </div>

    <div id="chatroom">
      <h1>Welcome: <span id="name"></span>!</h1>
      <!--dssassss -->
      <div id="room">
        <h2>You're now in room: <i id="active_room"></i></h2>
      </div>
      <h3>Messages:</h3>
      <form onsubmit="sendMessage(event)">
        <!-- <input type="text" placeholder="Who is sending the message?" name="from" id="from" /> -->
        <input
          type="text"
          placeholder="Write message!"
          name="new-message"
          id="new-message"
        />
        <button type="submit">
          Send message!
        </button>
      </form>

      <div id="messageDiv">
        <p id="messages"></p>
      </div>
    </div>

    <script src="cordova.js"></script>
    <script>
      document.getElementById("chatroom").style.display = "none";
    </script>
  </body>
</html>
